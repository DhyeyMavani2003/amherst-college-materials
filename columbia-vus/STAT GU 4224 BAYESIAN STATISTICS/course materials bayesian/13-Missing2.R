X = structure(list(glu = c(86L, 195L, 77L, NA, 107L, 97L, NA, 193L, 
                       142L, 128L, 137L, 154L, 189L, 92L, 86L, 99L, 109L, NA, 149L, 
                       139L, NA, 100L, 83L, 101L, 87L, 164L, 99L, 140L, 108L, 110L, 
                       79L, 148L, 121L, 158L, 105L, 145L, 79L, 71L, 102L, 119L, 176L, 
                       97L, 129L, 97L, 86L, 125L, 123L, 92L, 171L, 199L, 116L, 83L, 
                       154L, 114L, 106L, 127L, 124L, 109L, 123L, 167L, NA, 96L, 129L, 
                       92L, 109L, 139L, 134L, 106L, 131L, 135L, 158L, 112L, 181L, 121L, 
                       168L, 144L, 101L, 96L, 107L, NA, 100L, 154L, 125L, 125L, 122L, 
                       114L, 115L, 114L, 115L, 130L, 79L, 112L, 150L, 91L, 100L, 140L, 
                       110L, 94L, 84L, 148L, 61L, 117L, 99L, NA, 154L, 103L, 111L, 124L, 
                       NA, 81L, NA, 116L, 103L, 124L, 71L, 137L, 112L, 148L, 136L, 145L, 
                       NA, 107L, 151L, 97L, 144L, 112L, 99L, 109L, 120L, 187L, 129L, 
                       179L, 80L, 105L, NA, 95L, 99L, 137L, NA, 100L, 167L, 180L, 122L, 
                       90L, 120L, 154L, 56L, 177L, 124L, 85L, 88L, 152L, 198L, 188L, 
                       139L, 168L, 197L, 142L, 126L, 158L, 130L, 100L, 164L, 95L, 122L, 
                       85L, 151L, 144L, 111L, 107L, 115L, 105L, 194L, 184L, 95L, 124L, 
                       111L, 137L, 57L, NA, 95L, 140L, 117L, 100L, 123L, 138L, 100L, 
                       175L, NA, 133L, 119L, 155L, 128L, NA, 140L, 141L, 129L, 106L, 
                       118L, 155L), bp = c(68L, 70L, 82L, 76L, 60L, 76L, 58L, 50L, 80L, 
                                           78L, NA, 78L, 60L, NA, 66L, 76L, 60L, NA, NA, 62L, 70L, 66L, 
                                           86L, 64L, NA, 84L, 58L, 65L, 72L, 74L, 60L, 66L, 66L, 64L, 80L, 
                                           82L, 80L, 48L, 86L, 66L, 90L, 68L, NA, 64L, 68L, 60L, 74L, 76L, 
                                           72L, NA, 74L, NA, 78L, 66L, 70L, 88L, 74L, 38L, 48L, NA, 84L, 
                                           64L, 76L, 62L, 60L, 80L, 70L, 54L, 66L, 94L, 84L, 74L, 68L, 70L, 
                                           88L, 82L, 58L, 68L, 62L, 78L, 64L, 72L, 78L, 70L, 76L, 68L, 70L, 
                                           76L, 64L, 60L, 75L, 78L, NA, 54L, 72L, 82L, 76L, 76L, 50L, NA, 
                                           82L, 62L, 80L, 82L, 62L, NA, 64L, 70L, 74L, 74L, 110L, 72L, 66L, 
                                           76L, 78L, 84L, 82L, 60L, NA, 80L, 56L, 72L, 70L, NA, 82L, NA, 
                                           52L, 56L, 80L, 68L, NA, 95L, 66L, 58L, 68L, 80L, 72L, 68L, 70L, 
                                           NA, NA, 90L, 70L, 62L, 70L, 78L, 56L, 60L, 80L, 55L, 74L, 78L, 
                                           66L, 82L, NA, 88L, 70L, 82L, 74L, 76L, 78L, 54L, 82L, 60L, 52L, 
                                           58L, 90L, 72L, 90L, 68L, 60L, 72L, NA, 78L, 85L, 70L, 62L, 90L, 
                                           80L, 74L, 54L, 85L, 66L, NA, 70L, 60L, 78L, 62L, 52L, NA, 64L, 
                                           84L, NA, 68L, 74L, 58L, 68L, 70L, 58L, 62L), skin = c(28L, 33L, 
                                                                                                 NA, 43L, NA, 27L, 31L, 16L, 15L, NA, NA, 30L, 23L, 7L, 52L, 15L, 
                                                                                                 8L, 33L, 29L, 17L, 16L, 29L, 19L, 17L, 34L, 21L, 10L, NA, 43L, 
                                                                                                 29L, NA, 25L, 30L, 13L, 45L, 19L, 25L, 18L, 17L, NA, 34L, 21L, 
                                                                                                 12L, 19L, 32L, 20L, 40L, NA, 33L, 43L, NA, 23L, 32L, 36L, 28L, 
                                                                                                 11L, 36L, NA, 32L, 46L, 33L, 27L, 28L, 32L, 27L, NA, 23L, 21L, 
                                                                                                 40L, 46L, 41L, NA, 36L, 32L, 29L, 46L, 17L, 13L, 13L, 17L, 23L, 
                                                                                                 29L, 31L, NA, 27L, 22L, 30L, 17L, 22L, 23L, 30L, NA, 29L, 25L, 
                                                                                                 12L, 43L, 20L, 18L, 23L, 48L, 28L, 12L, 11L, 31L, 31L, NA, 39L, 
                                                                                                 20L, 22L, 41L, 31L, 12L, 32L, 24L, 50L, 27L, 32L, 27L, 50L, 46L, 
                                                                                                 11L, 30L, 40L, 40L, 26L, NA, 15L, 21L, NA, NA, 49L, 31L, 30L, 
                                                                                                 40L, 15L, 45L, 17L, 14L, 15L, 60L, 17L, NA, 27L, 12L, 30L, 41L, 
                                                                                                 NA, 29L, 33L, 20L, 40L, 34L, 32L, NA, 35L, 42L, 99L, 18L, 38L, 
                                                                                                 36L, 23L, 28L, 43L, 32L, NA, 22L, 46L, 27L, 12L, NA, 39L, 29L, 
                                                                                                 28L, 39L, 25L, 33L, 13L, 41L, 37L, 35L, 14L, NA, 31L, 40L, 44L, 
                                                                                                 35L, 25L, 30L, NA, 28L, 18L, 44L, 45L, 22L, 26L, 34L, 49L, 37L, 
                                                                                                 36L, 26L), bmi = c(30.2, NA, 35.8, 47.9, NA, NA, 34.3, 25.9, 
                                                                                                                    NA, 43.3, NA, 30.9, 30.1, 27.6, 41.3, 23.2, 25.4, 36.6, 29.3, 
                                                                                                                    22.1, 20.4, 32, 29.3, 21, 37.6, 30.8, 25.4, 42.6, 36.1, NA, 43.5, 
                                                                                                                    32.5, 34.3, 31.2, 33.7, 22.2, 25.4, 20.4, 29.3, 38.8, NA, 27.2, 
                                                                                                                    NA, 18.2, 35.8, 33.8, 34.1, 24.2, 33.3, NA, 26.3, 32.2, 32.4, 
                                                                                                                    38.1, 34.2, 34.5, 27.8, 23.1, 42.1, 37.6, 35.5, 33.2, 35.9, 32, 
                                                                                                                    25, 31.6, NA, 30.9, 34.3, 40.6, 39.4, 31.6, 30.1, 39.1, 35, 46.1, 
                                                                                                                    24.2, 21.1, 22.9, 26.5, 29.7, 31.3, 27.6, 31.1, 35.9, 28.7, 34.6, 
                                                                                                                    23.8, 30.8, NA, 32, 39.4, 35.2, 25.2, 25.3, 39.2, 28.4, 31.6, 
                                                                                                                    NA, 37.6, NA, NA, 19.3, 34.2, 32.8, 37.7, 34.2, 27.4, NA, 46.3, 
                                                                                                                    28.5, 22.1, 39.1, 28.7, 33.2, 27.3, 34.2, 30.9, 37.4, 37.9, 22.5, 
                                                                                                                    30.8, NA, 38.1, 32, 38.4, 24.6, 25.2, 38.9, 37.7, 36.4, 34.2, 
                                                                                                                    26.2, 34.9, 30.9, 36.5, 25.6, 24.8, 18.2, 46.8, 23.4, 36.5, 36.8, 
                                                                                                                    27.2, 42.9, 46.1, 24.2, 34.6, 33.2, 24.4, 35.3, NA, 41.3, 32, 
                                                                                                                    28.6, 38.2, 34.7, 24.7, NA, 31.6, 28.4, 37.8, 32.8, 35.4, 36.2, 
                                                                                                                    27.8, 42.1, 33.9, 28.4, 26.5, 33.7, 36.9, 35.9, NA, 37.4, 25.5, 
                                                                                                                    24, 32, 32.8, NA, NA, 37.4, 30.8, 39.4, 33.1, 34.6, 36.6, 33.6, 
                                                                                                                    27.8, 32.8, 34.9, 38.7, NA, 34.1, 24.1, 25.4, 38.5, 39.4, 33.3, 
                                                                                                                    34)), .Names = c("glu", "bp", "skin", "bmi"), row.names = c(NA, 200L), class = "data.frame")


## prior parameters
p = dim(X)[2]
n = dim(X)[1]
mu0<-c(120,64,26,26)
sd0<-(mu0/2)
L0<-matrix(.1,p,p) ; diag(L0)<-1 ; L0<-L0*outer(sd0,sd0)
nu0<-p+2 ; S0<-L0
###

### starting values
Sigma<-S0
X.full<-X
O = 1*(!is.na(X))
for(j in 1:p)
{
  X.full[is.na(X.full[,j]),j]<-mean(X.full[,j],na.rm=TRUE)
}
###


### Gibbs sampler
THETA<-SIGMA<-X.MISS<-NULL
library(MASS)
library(MCMCpack) # for the riwish function
for(s in 1:5000)
{
  
  ###update theta
  xbar<-apply(X.full,2,mean)
  Ln<-solve( solve(L0) + n*solve(Sigma) )
  mun<-Ln%*%( solve(L0)%*%mu0 + n*solve(Sigma)%*%xbar )
  theta<-mvrnorm(1,mun,Ln)
  ###
  
  ###update Sigma
  Sn<- S0 + ( t(X.full)-c(theta) )%*%t( t(X.full)-c(theta) )
 
  
  Sigma <- riwish(nu0+n, Sn)
  ###
  
  ###update missing data
  for(i in 1:n)
  { 
    b <- ( O[i,]==0 )
    if (sum(b) > 0)
    {
    a <- ( O[i,]==1 )
    iSa<- solve(Sigma[a,a])
    beta.j <- Sigma[b,a]%*%iSa
    s2.j   <- Sigma[b,b] - Sigma[b,a]%*%iSa%*%Sigma[a,b]
    theta.j<- theta[b] + beta.j%*%(t(X.full[i,a])-theta[a])
    X.full[i,b] <- mvrnorm(1,theta.j,s2.j )
    }
  }
  
  ### save results
  THETA<-rbind(THETA,theta) ; SIGMA<-rbind(SIGMA,c(Sigma))
  X.MISS<-rbind(X.MISS, X.full[O==0] )
  ###
 
}

#### Posterior mean and correlation matrix
apply(THETA,2,mean)

COR <- array( dim=c(p,p,5000) )
for(s in 1:5000)
{
  Sig<-matrix( SIGMA[s,] ,nrow=p,ncol=p)
  COR[,,s] <- Sig/sqrt( outer( diag(Sig),diag(Sig) ) )
}

apply(COR,c(1,2),mean)


## Missing data 2
# Using the MI package
# install.packages("mi")
library(mi)

# Getting the built-in dataset nlsyV
data(nlsyV, package = "mi")

# Create the missing data frame object
mdf = missing_data.frame(nlsyV)

# Five-number summary statistics + missing number
summary(mdf)

# Histograms of all variables with missing values
hist(mdf)

# Missing patterns
# Standardized observed values together with missing
image(mdf)

# Or look at the patterns numerically:
data.frame(tabulate(mdf@patterns), levels(mdf@patterns) )
# For example, 172 cases had "nothing" missingness pattern

# Examine the default settings
show(mdf)

# Make changes to some variables as an example
mdf = change(mdf, y = c("momrace"), what = "type", to = "un")
show(mdf)

# Running the chains
imputations <- mi(mdf)

(converged = mi2BUGS(imputations))
# Note the result is an array of matrices with all imputed variables means and sd's
# Each matrix is of order iter by m

# Extract specific variables from the imputations
(mean_ppvtr.36 = converged[, , 1])
mean_income = converged[, , 3]

# Switch back to 1x1 graph window
par(mfrow = c(1,1))

# Traceplot of mean imputed values of  ppvtr.36
ts.plot(mean_ppvtr.36[,1], col=1, ylim = c(-0.03, 0.03))
lines(mean_ppvtr.36[,2], col= 2)
lines(mean_ppvtr.36[,3], col= 3)
lines(mean_ppvtr.36[,4], col= 4)

# Traceplot of mean imputed income
ts.plot(mean_income[,1], col=1, ylim = c(-0.05, 0.05))
lines(mean_income[,2], col= 2)
lines(mean_income[,3], col= 3)
lines(mean_income [,4], col= 4)

# We can also check if the mean of each completed variable is roughly the same for each of the 4 chains.
round(mipply(imputations, mean, to.matrix = TRUE), 3)

# R-hat should be around 1
Rhats(imputations)

# Checks how good the models fit
plot(imputations)
# Turn off the "Hit <Return>" message
par(ask=F)
par(mfrow = c(1,1))
# Conclusion: Income variable clearly has a problem!

# How do we fix the problem with income?
# Look at income again
hist(nlsyV$income)
# It is highly right-skewed and has pileup at 0

# Make changes to income variable
mdf <- change(mdf, y = "income", what = "type", to = "nonn")
show(mdf)
# Note the log transformation on income!

# Check histograms again
hist(mdf)
# Now income looks more promising and symmetric

# Run the chains again!
# And we can always benefit from more iterations:
imputations <- mi(mdf, n.iter = 60)
Rhats(imputations)
converged <- mi2BUGS(imputations)

mean_income = converged[, , 3]
par(mfrow = c(1,1))
# Traceplot of mean imputed income
ts.plot(mean_income[,1], col=1)
lines(mean_income[,2], col= 2)
lines(mean_income[,3], col= 3)
lines(mean_income [,4], col= 4)

plot(imputations)

# Try pmm
mdf = missing_data.frame(nlsyV)


mdf <- change(mdf, y = c("momrace"), what = "type", to = "un")
show(mdf)
mdf <- change(mdf, y = "income", what ="imputation_method", to = "pmm")
show(mdf)
imputations <- mi(mdf, n.iter=60, parallel = F)


converged <- mi2BUGS(imputations)

mean_ppvtr.36 = converged[, , 1]
mean_income = converged[, , 3]

# Traceplot of mean income
par(ask=F)
par(mfrow = c(1,1))

ts.plot(mean_income[,1], col=1)
lines(mean_income[,2], col= 2)
lines(mean_income[,3], col= 3)
lines(mean_income [,4], col= 4)

plot(imputations)

analysis <- pool(ppvtr.36 ~ first + b.marr + scale(income) + momage + momed + momrace, imputations, m=5)
display(analysis)

# Compare to glm results:
summary(glm(ppvtr.36 ~ first + b.marr + scale(income) + momage + factor(momed) + factor(momrace), 
            family = gaussian, data = nlsyV))
# Note: 228 observations deleted due to missingness
# SE are larger
